<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>upgrading_ruby_on_rails.md</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../css/github.css" type="text/css" media="screen" />
<script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            upgrading_ruby_on_rails.md
        </h1>
        <ul class="files">
            <li>rails/guides/source/upgrading_ruby_on_rails.md</li>
            <li>Last modified: 2013-04-26 19:51:18 +0300</li>
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h1 id="label-A+Guide+for+Upgrading+Ruby+on+Rails"><a href="../../../../classes/A.html">A</a> Guide for Upgrading Ruby on <a href="../../../../classes/Rails.html">Rails</a></h1>

<p>This guide provides steps to be followed when you upgrade your applications
to a newer version of Ruby on <a
href="../../../../classes/Rails.html">Rails</a>. These steps are also
available in individual release guides.</p>

<h2 id="label-General+Advice">General Advice</h2>

<p>Before attempting to upgrade an existing application, you should be sure
you have a good reason to upgrade. You need to balance out several factors:
the need for new features, the increasing difficulty of finding support for
old code, and your available time and skills, to name a few.</p>

<h3 id="label-Test+Coverage">Test Coverage</h3>

<p>The best way to be sure that your application still works after upgrading
is to have good test coverage before you start the process. If you
don&#39;t have automated tests that exercise the bulk of your application,
you&#39;ll need to spend time manually exercising all the parts that have
changed. In the case of a <a
href="../../../../classes/Rails.html">Rails</a> upgrade, that will mean
every single piece of functionality in the application. Do yourself a favor
and make sure your test coverage is good <em>before</em> you start an
upgrade.</p>

<h3 id="label-Ruby+Versions">Ruby Versions</h3>

<p><a href="../../../../classes/Rails.html">Rails</a> generally stays close to
the latest released Ruby version when it&#39;s released:</p>
<ul><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 3 and above require Ruby
1.8.7 or higher. Support for all of the previous Ruby versions has been
dropped officially. You should upgrade as early as possible.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 3.2.x is the last branch
to support Ruby 1.8.7.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4 prefers Ruby 2.0 and
requires 1.9.3 or newer.</p>
</li></ul>

<p>TIP: Ruby 1.8.7 p248 and p249 have marshaling bugs that crash <a
href="../../../../classes/Rails.html">Rails</a>. Ruby Enterprise Edition
has these fixed since the release of 1.8.7-2010.02. On the 1.9 front, Ruby
1.9.1 is not usable because it outright segfaults, so if you want to use
1.9.x, jump straight to 1.9.3 for smooth sailing.</p>

<h2 id="label-Upgrading+from+Rails+3.2+to+Rails+4.0">Upgrading from <a href="../../../../classes/Rails.html">Rails</a> 3.2 to <a href="../../../../classes/Rails.html">Rails</a> 4.0</h2>

<p>NOTE: This section is a work in progress.</p>

<p>If your application is currently on any version of <a
href="../../../../classes/Rails.html">Rails</a> older than 3.2.x, you
should upgrade to <a href="../../../../classes/Rails.html">Rails</a> 3.2
before attempting one to <a href="../../../../classes/Rails.html">Rails</a>
4.0.</p>

<p>The following changes are meant for upgrading your application to <a
href="../../../../classes/Rails.html">Rails</a> 4.0.</p>

<h3 id="label-vendor%2Fplugins">vendor/plugins</h3>

<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 no longer supports
loading plugins from <code>vendor/plugins</code>. You must replace any
plugins by extracting them to gems and adding them to your <a
href="../../Gemfile.html">Gemfile</a>. If you choose not to make them gems,
you can move them into, say, <code>lib/my_plugin/*</code> and add an
appropriate initializer in <code>config/initializers/my_plugin.rb</code>.</p>

<h3 id="label-Active+Record">Active Record</h3>
<ul><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has removed the
identity map from Active Record, due to <a
href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">some
inconsistencies with associations</a>. If you have manually enabled it in
your application, you will have to remove the following config that has no
effect anymore: <code>config.active_record.identity_map</code>.</p>
</li><li>
<p>The <code>delete</code> method in collection associations can now receive
<code>Fixnum</code> or <code>String</code> arguments as record ids, besides
records, pretty much like the <code>destroy</code> method does. Previously
it raised <code>ActiveRecord::AssociationTypeMismatch</code> for such
arguments. From <a href="../../../../classes/Rails.html">Rails</a> 4.0 on
<code>delete</code> automatically tries to find the records matching the
given ids before deleting them.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has changed how
orders get stacked in <code>ActiveRecord::Relation</code>. In previous
versions of <a href="../../../../classes/Rails.html">Rails</a>, the new
order was applied after the previously defined order. But this is no longer
true. Check <a href="http://active_record_querying.html#ordering">Active
Record Query guide</a> for more information.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has changed
<code>serialized_attributes</code> and <code>attr_readonly</code> to class
methods only. Now you shouldn&#39;t use instance methods, it&#39;s
deprecated. You must change them, e.g.
<code>self.serialized_attributes</code> to
<code>self.class.serialized_attributes</code>.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has removed
<code>attr_accessible</code> and <code>attr_protected</code> feature in
favor of Strong Parameters. You can use the <a
href="https://github.com/rails/protected_attributes">Protected Attributes
gem</a> to a smoothly upgrade path.</p>
</li></ul>

<h3 id="label-Active+Resource">Active Resource</h3>

<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 extracted Active
Resource to its our gem. If you still need the feature you can add the <a
href="https://github.com/rails/activeresource">Active Resource gem</a> in
your <a href="../../Gemfile.html">Gemfile</a>.</p>

<h3 id="label-Active+Model">Active Model</h3>
<ul><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has changed how
errors attach with the
<code>ActiveModel::Validations::ConfirmationValidator</code>. Now when
confirmation validations fail the error will be attached to
<code>:#{attribute}_confirmation</code> instead of <code>attribute</code>.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has changed
<code>ActiveModel::Serializers::JSON.include_root_in_json</code> default
value to <code>false</code>. Now, Active Model Serializers and Active
Record objects have the same default behaviour. This means that you can
comment or remove the following option in the
<code>config/initializers/wrap_parameters.rb</code> file:</p>
</li></ul>

<pre><code># Disable root element in JSON by default.
# ActiveSupport.on_load(:active_record) do
#   self.include_root_in_json = false
# end
</code></pre>

<h3 id="label-Action+Pack">Action Pack</h3>
<ul><li>
<p>There is an upgrading cookie store
<code>UpgradeSignatureToEncryptionCookieStore</code> which helps you
upgrading apps that use <code>CookieStore</code> to the new default
<code>EncryptedCookieStore</code>. To use this <code>CookieStore</code> set
<code>Myapp::Application.config.session_store
:upgrade_signature_to_encryption_cookie_store, key:
&#39;_myapp_session&#39;</code> in
<code>config/initializers/session_store.rb</code>. Additionally, add
<code>Myapp::Application.config.secret_key_base = &#39;some
secret&#39;</code> in <code>config/initializers/secret_token.rb</code>. Do
not remove <code>Myapp::Application.config.secret_token = &#39;some
secret&#39;</code>.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 removed the
<code>ActionController::Base.asset_path</code> option. Use the assets
pipeline feature.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has deprecated
<code>ActionController::Base.page_cache_extension</code> option. Use
<code>ActionController::Base.default_static_extension</code> instead.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has removed Action
and Page caching from Action Pack. You will need to add the
<code>actionpack-action_caching</code> gem in order to use
<code>caches_action</code> and the <code>actionpack-page_caching</code> to
use <code>caches_pages</code> in your controllers.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 changed how
<code>assert_generates</code>, <code>assert_recognizes</code>, and
<code>assert_routing</code> work. Now all these assertions raise
<code>Assertion</code> instead of
<code>ActionController::RoutingError</code>.</p>
</li><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 also changed the way
unicode character routes are drawn. Now you can draw unicode character
routes directly. If you already draw such routes, you must change them, for
example:</p>
</li></ul>

<pre><code>get Rack::Utils.escape(&#39;こんにちは&#39;), controller: &#39;welcome&#39;, action: &#39;index&#39;
</code></pre>

<p>becomes</p>

<pre><code>get &#39;こんにちは&#39;, controller: &#39;welcome&#39;, action: &#39;index&#39;
</code></pre>
<ul><li>
<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 has removed
ActionDispatch::BestStandardsSupport middleware, !DOCTYPE html already
triggers standards mode per <a
href="http://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a>
and ChromeFrame header has been moved to
<code>config.action_dispatch.default_headers</code></p>
</li></ul>

<p>Remember you must also remove any references to the middleware from your
application code, for example:</p>

<pre><code># Raise exception
config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport)
</code></pre>

<p>Also check your environment settings for
<code>config.action_dispatch.best_standards_support</code> and remove it if
present.</p>
<ul><li>
<p>In <a href="../../../../classes/Rails.html">Rails</a> 4.0, precompiling
assets no longer automatically copies non-JS/CSS assets from
<code>vendor/assets</code> and <code>lib/assets</code>. <a
href="../../../../classes/Rails.html">Rails</a> application and engine
developers should put these assets in <code>app/assets</code> or configure
<code>config.assets.precompile</code>.</p>
</li></ul>

<h3 id="label-Active+Support">Active Support</h3>

<p><a href="../../../../classes/Rails.html">Rails</a> 4.0 removes the
<code>j</code> alias for <code>ERB::Util#json_escape</code> since
<code>j</code> is already used for
<code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>.</p>

<h3 id="label-Helpers+Loading+Order">Helpers Loading <a href="../../../../classes/Order.html">Order</a></h3>

<p>The order in which helpers from more than one directory are loaded has
changed in <a href="../../../../classes/Rails.html">Rails</a> 4.0.
Previously, they were gathered and then sorted alphabetically. After
upgrading to <a href="../../../../classes/Rails.html">Rails</a> 4.0,
helpers will preserve the order of loaded directories and will be sorted
alphabetically only within each directory. Unless you explicitly use the
<code>helpers_path</code> parameter, this change will only impact the way
of loading helpers from engines. If you rely on the ordering, you should
check if correct methods are available after upgrade. If you would like to
change the order in which engines are loaded, you can use
<code>config.railties_order=</code> method.</p>

<h2 id="label-Upgrading+from+Rails+3.1+to+Rails+3.2">Upgrading from <a href="../../../../classes/Rails.html">Rails</a> 3.1 to <a href="../../../../classes/Rails.html">Rails</a> 3.2</h2>

<p>If your application is currently on any version of <a
href="../../../../classes/Rails.html">Rails</a> older than 3.1.x, you
should upgrade to <a href="../../../../classes/Rails.html">Rails</a> 3.1
before attempting an update to <a
href="../../../../classes/Rails.html">Rails</a> 3.2.</p>

<p>The following changes are meant for upgrading your application to <a
href="../../../../classes/Rails.html">Rails</a> 3.2.2, the latest 3.2.x
version of <a href="../../../../classes/Rails.html">Rails</a>.</p>

<h3 id="label-Gemfile"><a href="../../Gemfile.html">Gemfile</a></h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre><code>gem &#39;rails&#39;, &#39;= 3.2.2&#39;

group :assets do
  gem &#39;sass-rails&#39;,   &#39;~&gt; 3.2.3&#39;
  gem &#39;coffee-rails&#39;, &#39;~&gt; 3.2.1&#39;
  gem &#39;uglifier&#39;,     &#39;&gt;= 1.0.3&#39;
end
</code></pre>

<h3 id="label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb</h3>

<p>There are a couple of new configuration settings that you should add to
your development environment:</p>

<pre><code># Raise exception on mass assignment protection for Active Record models
config.active_record.mass_assignment_sanitizer = :strict

# Log the query plan for queries taking more than this (works
# with SQLite, MySQL, and PostgreSQL)
config.active_record.auto_explain_threshold_in_seconds = 0.5
</code></pre>

<h3 id="label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb</h3>

<p>The <code>mass_assignment_sanitizer</code> configuration setting should
also be be added to <code>config/environments/test.rb</code>:</p>

<pre><code># Raise exception on mass assignment protection for Active Record models
config.active_record.mass_assignment_sanitizer = :strict
</code></pre>

<h3 id="label-vendor%2Fplugins">vendor/plugins</h3>

<p><a href="../../../../classes/Rails.html">Rails</a> 3.2 deprecates
<code>vendor/plugins</code> and <a
href="../../../../classes/Rails.html">Rails</a> 4.0 will remove them
completely. While it&#39;s not strictly necessary as part of a <a
href="../../../../classes/Rails.html">Rails</a> 3.2 upgrade, you can start
replacing any plugins by extracting them to gems and adding them to your <a
href="../../Gemfile.html">Gemfile</a>. If you choose not to make them gems,
you can move them into, say, <code>lib/my_plugin/*</code> and add an
appropriate initializer in <code>config/initializers/my_plugin.rb</code>.</p>

<h2 id="label-Upgrading+from+Rails+3.0+to+Rails+3.1">Upgrading from <a href="../../../../classes/Rails.html">Rails</a> 3.0 to <a href="../../../../classes/Rails.html">Rails</a> 3.1</h2>

<p>If your application is currently on any version of <a
href="../../../../classes/Rails.html">Rails</a> older than 3.0.x, you
should upgrade to <a href="../../../../classes/Rails.html">Rails</a> 3.0
before attempting an update to <a
href="../../../../classes/Rails.html">Rails</a> 3.1.</p>

<p>The following changes are meant for upgrading your application to <a
href="../../../../classes/Rails.html">Rails</a> 3.1.3, the latest 3.1.x
version of <a href="../../../../classes/Rails.html">Rails</a>.</p>

<h3 id="label-Gemfile"><a href="../../Gemfile.html">Gemfile</a></h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre><code>gem &#39;rails&#39;, &#39;= 3.1.3&#39;
gem &#39;mysql2&#39;

# Needed for the new asset pipeline
group :assets do
  gem &#39;sass-rails&#39;,   &quot;~&gt; 3.1.5&quot;
  gem &#39;coffee-rails&#39;, &quot;~&gt; 3.1.1&quot;
  gem &#39;uglifier&#39;,     &quot;&gt;= 1.0.3&quot;
end

# jQuery is the default JavaScript library in Rails 3.1
gem &#39;jquery-rails&#39;
</code></pre>

<h3 id="label-config%2Fapplication.rb">config/application.rb</h3>

<p>The asset pipeline requires the following additions:</p>

<pre><code>config.assets.enabled = true
config.assets.version = &#39;1.0&#39;
</code></pre>

<p>If your application is using an “/assets” route for a resource you may want
change the prefix used for assets to avoid conflicts:</p>

<pre><code># Defaults to &#39;/assets&#39;
config.assets.prefix = &#39;/asset-files&#39;
</code></pre>

<h3 id="label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb</h3>

<p>Remove the RJS setting <code>config.action_view.debug_rjs = true</code>.</p>

<p>Add these settings if you enable the asset pipeline:</p>

<pre><code># Do not compress assets
config.assets.compress = false

# Expands the lines which load the assets
config.assets.debug = true
</code></pre>

<h3 id="label-config%2Fenvironments%2Fproduction.rb">config/environments/production.rb</h3>

<p>Again, most of the changes below are for the asset pipeline. You can read
more about these in the <a href="http://asset_pipeline.html">Asset
Pipeline</a> guide.</p>

<pre><code># Compress JavaScripts and CSS
config.assets.compress = true

# Don&#39;t fallback to assets pipeline if a precompiled asset is missed
config.assets.compile = false

# Generate digests for assets URLs
config.assets.digest = true

# Defaults to Rails.root.join(&quot;public/assets&quot;)
# config.assets.manifest = YOUR_PATH

# Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)
# config.assets.precompile += %w( search.js )

# Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.
# config.force_ssl = true
</code></pre>

<h3 id="label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb</h3>

<p>You can help test performance with these additions to your test
environment:</p>

<pre><code># Configure static asset server for tests with Cache-Control for performance
config.serve_static_assets = true
config.static_cache_control = &quot;public, max-age=3600&quot;
</code></pre>

<h3 id="label-config%2Finitializers%2Fwrap_parameters.rb">config/initializers/wrap_parameters.rb</h3>

<p>Add this file with the following contents, if you wish to wrap parameters
into a nested hash. This is on by default in new applications.</p>

<pre><code># Be sure to restart your server when you modify this file.
# This file contains settings for ActionController::ParamsWrapper which
# is enabled by default.

# Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.
ActiveSupport.on_load(:action_controller) do
  wrap_parameters format: [:json]
end

# Disable root element in JSON by default.
ActiveSupport.on_load(:active_record) do
  self.include_root_in_json = false
end
</code></pre>

<h3 id="label-config%2Finitializers%2Fsession_store.rb">config/initializers/session_store.rb</h3>

<p>You need to change your session key to something new, or remove all
sessions:</p>

<pre><code># in config/initializers/session_store.rb
AppName::Application.config.session_store :cookie_store, key: &#39;SOMETHINGNEW&#39;
</code></pre>

<p>or</p>

<pre><code>$ rake db:sessions:clear</code></pre>

<h3 id="label-Remove+%3Acache+and+%3Aconcat+options+in+asset+helpers+references+in+views">Remove :cache and :concat options in asset helpers references in views</h3>
<ul><li>
<p>With the Asset Pipeline the :cache and :concat options aren&#39;t used
anymore, delete these options from your views.</p>
</li></ul>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
              </div>

    </div>
  </body>
</html>