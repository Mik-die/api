<!DOCTYPE html>
<html lang="en">
<head>
    <title>connection_monitor.coffee</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../../../../../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../../../../css/github.css" type="text/css" media="screen" />
<script src="../../../../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>
    <div class="banner">
        
        <h1>
            connection_monitor.coffee
        </h1>
        <ul class="files">
            
            <li>
                rails/actioncable/app/assets/javascripts/action_cable/connection_monitor.coffee
                
                    <a href="https://github.com/rails/rails/blob/45b6b7f57f1a2eb757eb612fcc94e42d5908ec21/actioncable/app/assets/javascripts/action_cable/connection_monitor.coffee" target="_blank" class="github_url">on GitHub</a>
                
            </li>
            <li>Last modified: 2019-08-09 23:12:34 +0300</li>
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p># Responsible for ensuring the cable connection is in good health by validating the heartbeat pings sent from the server, and attempting # revival reconnections if things go astray. Internal class, not intended for direct user manipulation. class <a href="../../../../../../../classes/ActionCable.html"><code>ActionCable</code></a>.ConnectionMonitor</p>

<pre><code>@pollInterval:
  min: 3
  max: 30

@staleThreshold: 6 # Server::Connections::BEAT_INTERVAL * 2 (missed two pings)

constructor: (@connection) -&gt;
  @reconnectAttempts = 0

start: -&gt;
  unless @isRunning()
    @startedAt = now()
    delete @stoppedAt
    @startPolling()
    document.addEventListener(&quot;visibilitychange&quot;, @visibilityDidChange)
    ActionCable.log(&quot;ConnectionMonitor started. pollInterval = #{@getPollInterval()} ms&quot;)

stop: -&gt;
  if @isRunning()
    @stoppedAt = now()
    @stopPolling()
    document.removeEventListener(&quot;visibilitychange&quot;, @visibilityDidChange)
    ActionCable.log(&quot;ConnectionMonitor stopped&quot;)

isRunning: -&gt;
  @startedAt? and not @stoppedAt?

recordPing: -&gt;
  @pingedAt = now()

recordConnect: -&gt;
  @reconnectAttempts = 0
  @recordPing()
  delete @disconnectedAt
  ActionCable.log(&quot;ConnectionMonitor recorded connect&quot;)

recordDisconnect: -&gt;
  @disconnectedAt = now()
  ActionCable.log(&quot;ConnectionMonitor recorded disconnect&quot;)

# Private

startPolling: -&gt;
  @stopPolling()
  @poll()

stopPolling: -&gt;
  clearTimeout(@pollTimeout)

poll: -&gt;
  @pollTimeout = setTimeout =&gt;
    @reconnectIfStale()
    @poll()
  , @getPollInterval()

getPollInterval: -&gt;
  {min, max} = @constructor.pollInterval
  interval = 5 * Math.log(@reconnectAttempts + 1)
  Math.round(clamp(interval, min, max) * 1000)

reconnectIfStale: -&gt;
  if @connectionIsStale()
    ActionCable.log(&quot;ConnectionMonitor detected stale connection. reconnectAttempts = #{@reconnectAttempts}, pollInterval = #{@getPollInterval()} ms, time disconnected = #{secondsSince(@disconnectedAt)} s, stale threshold = #{@constructor.staleThreshold} s&quot;)
    @reconnectAttempts++
    if @disconnectedRecently()
      ActionCable.log(&quot;ConnectionMonitor skipping reopening recent disconnect&quot;)
    else
      ActionCable.log(&quot;ConnectionMonitor reopening&quot;)
      @connection.reopen()

connectionIsStale: -&gt;
  secondsSince(@pingedAt ? @startedAt) &gt; @constructor.staleThreshold

disconnectedRecently: -&gt;
  @disconnectedAt and secondsSince(@disconnectedAt) &lt; @constructor.staleThreshold

visibilityDidChange: =&gt;
  if document.visibilityState is &quot;visible&quot;
    setTimeout =&gt;
      if @connectionIsStale() or not @connection.isOpen()
        ActionCable.log(&quot;ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = #{document.visibilityState}&quot;)
        @connection.reopen()
    , 200

now = -&gt;
  new Date().getTime()

secondsSince = (time) -&gt;
  (now() - time) / 1000

clamp = (number, min, max) -&gt;
  Math.max(min, Math.min(max, number))
</code></pre>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
    
    
    
  
</div>

    </div>
  </body>
</html>
